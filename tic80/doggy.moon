-- title:  Doggy
-- author: Dadum
-- desc:   Play as a doggy!
-- script: moon

sprite_flags =
	solid: 0

class Vector
	new: (x,y) =>
		@x,@y = x,y
	distance: (other) =>
		math.sqrt((@x-other.x)^2 + (@y-other.y)^2)
	angle: => 
		math.atan(@x, -@y)
	rotated_degrees: (deg) => 
		angle = deg / 360
		x = @x * math.cos(angle) + @y * math.sin(angle)
		y = @y * math.cos(angle) + @x * math.sin(angle)
		Vector(x,y)

class SphereCollider
	-- x and y are relative to origin of body
	new: (x,y,r) =>
		@pos = Vector(x,y)
		@r = r

class BoxCollider
	-- x and y are relative to origin of body
	new: (x,y,w,h) =>
		@pos = Vector(x,y)
		@w,@h = w,h
	collide: (other) =>
		distance = @pos\distance(other.pos)
		if other.__class == SphereCollider
			1
		elseif other.__class == BoxCollider
			1

class Entity
	@all_entities = {}
	new:(x,y,dx,dy, dyy, collider) =>
		@pos = Vector(x,y)
		@dx,@dy = dx,dy
		@dyy = dyy
		@collider = collider

		table.insert(@@all_entities, self)

	update_physics: => 
		new_x = @pos.x + @dx
		new_y =	@pos.y + @dy
		@dy += @dyy
		
		-- TODO need to collide
		
	update: =>
		for e in *@@all_entities
			e\update()
			e\update_physics()
	draw: =>
		for e in *@@all_entities
			e\draw()	
			
class Doggy extends Entity
		add_to_map: (mapx, mapy) ->
			wx, wy = mapx*8, mapy*8
			mset(mapx,mapy,0)
			Doggy(wx,wy,0,0,0,BoxCollider(0,0,8,8))
		draw: =>
			spr(256,@pos.x,@pos.y)
		update: =>

class MapCollider
	@all_map_colliders = {}
	new:(x,y) =>
		@@all_map_colliders["s"] = BoxCollider(x,y,8,8)
	

init_map_entities = ->
	for x=0,239 
		for y=0,135 
			sprite_num = mget(x,y)
			
			if fget(sprite_num,sprite_flags.solid)
				MapCollider(x,y)
			
			switch sprite_num
				when 15 then Doggy.add_to_map(x,y)
	

initialize_stuff = ->
	init_map_entities()

initialize_stuff()

export TIC = ->
	cls(13)
	map(0,0,30,17)

	Entity\update!
	Entity\draw!
-- <TILES>
-- 001:eccccccccc888888caaaaaaaca888888cacccccccacc0ccccacc0ccccacc0ccc
-- 002:ccccceee8888cceeaaaa0cee888a0ceeccca0ccc0cca0c0c0cca0c0c0cca0c0c
-- 003:eccccccccc888888caaaaaaaca888888cacccccccacccccccacc0ccccacc0ccc
-- 004:ccccceee8888cceeaaaa0cee888a0ceeccca0cccccca0c0c0cca0c0c0cca0c0c
-- 005:2424424242322323232222324223322342233223232222324232232323233232
-- 006:4242242423322332433333342234432222344322433333342332233242422424
-- 015:0000000000333000003003000030030000300300003003000033300000000000
-- 017:cacccccccaaaaaaacaaacaaacaaaaccccaaaaaaac8888888cc000cccecccccec
-- 018:ccca00ccaaaa0ccecaaa0ceeaaaa0ceeaaaa0cee8888ccee000cceeecccceeee
-- 019:cacccccccaaaaaaacaaacaaacaaaaccccaaaaaaac8888888cc000cccecccccec
-- 020:ccca00ccaaaa0ccecaaa0ceeaaaa0ceeaaaa0cee8888ccee000cceeecccceeee
-- </TILES>

-- <SPRITES>
-- 000:0000000000030030000500500005555003001100005055000055550000500500
-- 001:0000000000030030000500500005555003001100005055000055550005000050
-- 002:0000000000030030000500500005555000001100035055000055550005000050
-- 003:0000000000030030000500500005555003001100005055000055550005000050
-- 016:0000000000030030000500500005555000001100035055000055550000500500
-- </SPRITES>

-- <MAP>
-- 003:00f000006060500000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:606060605060606060605060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:606060606060606060606060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:506050606060506060606050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <FLAGS>
-- 000:00000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

